#include "user_battery.h"

#include <stdio.h>

#include "app_log.h"
#include "user_common.h"

#include "STNS01/stns01.h"

#define PNAS150733AV_USED (0)
#define GRP170725_USED    (1)

#if GRP170725_USED
static double VOLTAGE_TABLE_CHARGE[101][2] = {
    {3.474, 0},  {3.659, 1},  {3.718, 2},  {3.743, 3},  {3.759, 4},  {3.762, 5},  {3.766, 6},  {3.769, 7},  {3.774, 8},  {3.778, 9},
    {3.784, 10}, {3.788, 11}, {3.796, 12}, {3.800, 13}, {3.807, 14}, {3.811, 15}, {3.818, 16}, {3.822, 17}, {3.828, 18}, {3.832, 19},
    {3.837, 20}, {3.840, 21}, {3.845, 22}, {3.848, 23}, {3.852, 24}, {3.853, 25}, {3.856, 26}, {3.858, 27}, {3.862, 28}, {3.863, 29},
    {3.865, 30}, {3.868, 31}, {3.870, 32}, {3.872, 33}, {3.875, 34}, {3.878, 35}, {3.880, 36}, {3.884, 37}, {3.886, 38}, {3.890, 39},
    {3.893, 40}, {3.897, 41}, {3.900, 42}, {3.904, 43}, {3.907, 44}, {3.912, 45}, {3.915, 46}, {3.920, 47}, {3.923, 48}, {3.928, 49},
    {3.932, 50}, {3.938, 51}, {3.941, 52}, {3.947, 53}, {3.951, 54}, {3.956, 55}, {3.963, 56}, {3.967, 57}, {3.973, 58}, {3.978, 59},
    {3.984, 60}, {3.991, 61}, {3.995, 62}, {4.000, 63}, {4.006, 64}, {4.010, 65}, {4.016, 66}, {4.022, 67}, {4.028, 68}, {4.034, 69},
    {4.040, 70}, {4.044, 71}, {4.050, 72}, {4.055, 73}, {4.061, 74}, {4.068, 75}, {4.076, 76}, {4.084, 77}, {4.097, 78}, {4.107, 79},
    {4.121, 80}, {4.131, 81}, {4.144, 82}, {4.149, 83}, {4.158, 84}, {4.164, 85}, {4.171, 86}, {4.178, 87}, {4.186, 88}, {4.194, 89},
    {4.200, 90}, {4.200, 91}, {4.200, 92}, {4.200, 93}, {4.200, 94}, {4.200, 95}, {4.200, 96}, {4.200, 97}, {4.200, 98}, {4.200, 99},
    {4.200, 100}
};

static double VOLTAGE_TABLE_DISCHARGE[101][2] = {
    {3.100, 0},  {3.244, 1},  {3.350, 2},  {3.430, 3},  {3.477, 4},  {3.518, 5},  {3.555, 6},  {3.576, 7},  {3.592, 8},  {3.603, 9},
    {3.611, 10}, {3.617, 11}, {3.624, 12}, {3.629, 13}, {3.632, 14}, {3.636, 15}, {3.640, 16}, {3.644, 17}, {3.649, 18}, {3.654, 19},
    {3.758, 20}, {3.663, 21}, {3.668, 22}, {3.672, 23}, {3.676, 24}, {3.681, 25}, {3.684, 26}, {3.686, 27}, {3.691, 28}, {3.693, 29},
    {3.697, 30}, {3.700, 31}, {3.702, 32}, {3.706, 33}, {3.709, 34}, {3.714, 35}, {3.716, 36}, {3.720, 37}, {3.723, 38}, {3.727, 39},
    {3.729, 40}, {3.733, 41}, {3.736, 42}, {3.739, 43}, {3.743, 44}, {3.747, 45}, {3.752, 46}, {3.755, 47}, {3.756, 48}, {3.763, 49},
    {3.767, 50}, {3.770, 51}, {3.775, 52}, {3.779, 53}, {3.783, 54}, {3.787, 55}, {3.791, 56}, {3.797, 57}, {3.802, 58}, {3.808, 59},
    {3.813, 60}, {3.819, 61}, {3.824, 62}, {3.829, 63}, {3.835, 64}, {3.840, 65}, {3.856, 66}, {3.852, 67}, {3.859, 68}, {3.865, 69},
    {3.872, 70}, {3.879, 71}, {3.883, 72}, {3.890, 73}, {3.895, 74}, {3.901, 75}, {3.907, 76}, {3.914, 77}, {3.923, 78}, {3.935, 79},
    {3.943, 80}, {3.957, 81}, {3.967, 82}, {3.979, 83}, {3.988, 84}, {3.995, 85}, {4.002, 86}, {4.009, 87}, {4.016, 88}, {4.025, 89},
    {4.035, 90}, {4.043, 91}, {4.054, 92}, {4.061, 93}, {4.071, 94}, {4.080, 95}, {4.091, 96}, {4.100, 97}, {4.112, 98}, {4.126, 99},
    {4.162, 100}
};

#elif PNAS150733AV_USED
static double VOLTAGE_TABLE_CHARGE[101][2] = {
    {3.350, 0},  {3.527, 1},  {3.624, 2},  {3.676, 3},  {3.721, 4},  {3.739, 5},  {3.744, 6},  {3.748, 7},  {3.751, 8},  {3.755, 9},
    {3.760, 10}, {3.767, 11}, {3.773, 12}, {3.780, 13}, {3.786, 14}, {3.793, 15}, {3.799, 16}, {3.805, 17}, {3.811, 18}, {3.817, 19},
    {3.822, 20}, {3.826, 21}, {3.830, 22}, {3.833, 23}, {3.836, 24}, {3.839, 25}, {3.841, 26}, {3.843, 27}, {3.846, 28}, {3.848, 29},
    {3.850, 30}, {3.852, 31}, {3.855, 32}, {3.857, 33}, {3.860, 34}, {3.863, 35}, {3.866, 36}, {3.869, 37}, {3.872, 38}, {3.876, 39},
    {3.879, 40}, {3.882, 41}, {3.887, 42}, {3.892, 43}, {3.896, 44}, {3.901, 45}, {3.905, 46}, {3.911, 47}, {3.916, 48}, {3.921, 49},
    {3.927, 50}, {3.933, 51}, {3.940, 52}, {3.946, 53}, {3.954, 54}, {3.960, 55}, {3.966, 56}, {3.974, 57}, {3.980, 58}, {3.987, 59},
    {3.994, 60}, {4.002, 61}, {4.008, 62}, {4.017, 63}, {4.023, 64}, {4.030, 65}, {4.037, 66}, {4.044, 67}, {4.055, 68}, {4.064, 69},
    {4.078, 70}, {4.091, 71}, {4.107, 72}, {4.120, 73}, {4.129, 74}, {4.138, 75}, {4.144, 76}, {4.153, 77}, {4.160, 78}, {4.171, 79},
    {4.180, 80}, {4.191, 81}, {4.200, 82}, {4.210, 83}, {4.222, 84}, {4.232, 85}, {4.244, 86}, {4.255, 87}, {4.268, 88}, {4.279, 89},
    {4.292, 90}, {4.304, 91}, {4.315, 92}, {4.329, 93}, {4.341, 94}, {4.345, 95}, {4.345, 96}, {4.345, 97}, {4.345, 98}, {4.345, 99},
    {4.345, 100}
};

static double VOLTAGE_TABLE_DISCHARGE[101][2] = {
    {3.350, 0},  {3.527, 1},  {3.624, 2},  {3.676, 3},  {3.721, 4},  {3.739, 5},  {3.744, 6},  {3.748, 7},  {3.751, 8},  {3.755, 9},
    {3.760, 10}, {3.767, 11}, {3.773, 12}, {3.780, 13}, {3.786, 14}, {3.793, 15}, {3.799, 16}, {3.805, 17}, {3.811, 18}, {3.817, 19},
    {3.822, 20}, {3.826, 21}, {3.830, 22}, {3.833, 23}, {3.836, 24}, {3.839, 25}, {3.841, 26}, {3.843, 27}, {3.846, 28}, {3.848, 29},
    {3.850, 30}, {3.852, 31}, {3.855, 32}, {3.857, 33}, {3.860, 34}, {3.863, 35}, {3.866, 36}, {3.869, 37}, {3.872, 38}, {3.876, 39},
    {3.879, 40}, {3.882, 41}, {3.887, 42}, {3.892, 43}, {3.896, 44}, {3.901, 45}, {3.905, 46}, {3.911, 47}, {3.916, 48}, {3.921, 49},
    {3.927, 50}, {3.933, 51}, {3.940, 52}, {3.946, 53}, {3.954, 54}, {3.960, 55}, {3.966, 56}, {3.974, 57}, {3.980, 58}, {3.987, 59},
    {3.994, 60}, {4.002, 61}, {4.008, 62}, {4.017, 63}, {4.023, 64}, {4.030, 65}, {4.037, 66}, {4.044, 67}, {4.055, 68}, {4.064, 69},
    {4.078, 70}, {4.091, 71}, {4.107, 72}, {4.120, 73}, {4.129, 74}, {4.138, 75}, {4.144, 76}, {4.153, 77}, {4.160, 78}, {4.171, 79},
    {4.180, 80}, {4.191, 81}, {4.200, 82}, {4.210, 83}, {4.222, 84}, {4.232, 85}, {4.244, 86}, {4.255, 87}, {4.268, 88}, {4.279, 89},
    {4.292, 90}, {4.304, 91}, {4.315, 92}, {4.329, 93}, {4.341, 94}, {4.345, 95}, {4.345, 96}, {4.345, 97}, {4.345, 98}, {4.345, 99},
    {4.345, 100}
};

#endif

static uint16_t s_battery_level = BATTERY_LEVEL_FULL;

uint16_t get_charging_battery_level() {
    double voltage = 0.0;

    voltage = stns01_get_voltage(STNS01_CHANNEL_CHARGING);
    APP_LOG_DEBUG("Now VABAT Power is %.3fV", voltage);

    if (voltage >= BAT_VOL_CHARGE_FULL) {
        s_battery_level = BATTERY_LEVEL_FULL;

    } else if (voltage >= BAT_VOL_CHARGE_HIGH) {
        s_battery_level = BATTERY_LEVEL_HIGH;

    } else if (voltage >= BAT_VOL_CHARGE_LOW) {
        s_battery_level = BATTERY_LEVEL_NORMAL;

    } else if (voltage >= BAT_VOL_CHARGE_EMPTY) {
        s_battery_level = BATTERY_LEVEL_LOW;

    } else {
        s_battery_level = BATTERY_LEVEL_EMPTY;
    }

    return s_battery_level;
}

uint16_t get_discharging_battery_level() {
    double voltage = 0.0;

    voltage = stns01_get_voltage(STNS01_CHANNEL_BATTERY);
    APP_LOG_DEBUG("Now VABAT Power is %.3fV", voltage);

    if (voltage >= BAT_VOL_DISCHARGE_FULL) {
        s_battery_level = BATTERY_LEVEL_FULL;

    } else if (voltage >= BAT_VOL_DISCHARGE_HIGH) {
        s_battery_level = BATTERY_LEVEL_HIGH;

    } else if (voltage >= BAT_VOL_DISCHARGE_LOW) {
        s_battery_level = BATTERY_LEVEL_NORMAL;

    } else if (voltage >= BAT_VOL_DISCHARGE_EMPTY) {
        s_battery_level = BATTERY_LEVEL_LOW;

    } else {
        s_battery_level = BATTERY_LEVEL_EMPTY;
    }

    return s_battery_level;
}

uint16_t get_battery_percentage(uint8_t channel) {
    double(*voltage_table)[2]    = NULL;
    double   voltage             = 0.0;
    uint16_t battery_percentage  = 0;

    if (channel == VOL_CHAN_CHARGING) {
        voltage_table = VOLTAGE_TABLE_CHARGE;
    } else if (channel == VOL_CHAN_DISCHARGING) {
        voltage_table = VOLTAGE_TABLE_DISCHARGE;
    } else {
        APP_LOG_ERROR("Unknown channel[%d]", channel);
        return GUNTER_FAILURE;
    }

    voltage = stns01_get_voltage(channel);
    APP_LOG_DEBUG("Voltage of th channel [%d] is %.3fV", channel, voltage);

    if (voltage >= voltage_table[100][0]) {
        battery_percentage = 100;
        return battery_percentage;
    } else if (voltage <= voltage_table[0][0]) {
        battery_percentage = 0;
        return battery_percentage;
    } else {
        for (int i = 0; i < 101; i++) {
            if (voltage >= voltage_table[i][0] &&
                voltage < voltage_table[i + 1][0]) {
                battery_percentage = (uint16_t)voltage_table[i][1];
                break;
            }
        }
    }

    return battery_percentage;
}

